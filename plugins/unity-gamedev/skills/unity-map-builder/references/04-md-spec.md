# Map Builder Agent - MD 명세

> MD는 대화와 합의의 중심 - **작업 문서**

---

## 역할

```
MD는 "작업 문서" (Working Document)

핵심 역할:
├── 대화/합의 단계의 주 매체
├── 유저와 AI가 함께 수정하며 완성
├── Image, JSON의 원본 소스
└── ASCII 다이어그램으로 시각적 표현 포함

소비자:
├── AI: 컨텍스트 이해, Image/JSON 생성 기반
└── 유저: 직접 검토, 수정 요청, 승인

생성 순서:
├── 1️⃣ MD 먼저 작성 (유저와 반복 수정)
├── 2️⃣ 유저 승인 후 Image 생성
└── 3️⃣ Image 승인 후 JSON 생성
```

---

## 세 산출물의 관계

```
        ┌─────────────────────────────────┐
        │      합의된 내용 (개념적)         │
        │  "교실 3개 + 복도, 문으로 연결"   │
        └─────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        ↓             ↓             ↓
    ┌───────┐    ┌───────┐    ┌───────┐
    │ JSON  │ ←→ │  MD   │ ←→ │ Image │
    │정밀수치│    │텍스트 │    │시각화 │
    └───────┘    └───────┘    └───────┘
        │             │             │
        └─────────────┴─────────────┘
                      │
              모두 동일한 내용
              서로 일치해야 함
```

---

## 작업 흐름

### 1단계: MD 작성 (대화/합의)

```
유저: "교실 2개가 있고, 가운데 복도로 연결돼요. 복도 폭은 3미터쯤?"

AI가 MD 초안 작성:
┌────────────────────────────────────────────────────────┐
│ # School_01                                            │
│                                                        │
│ ## 공간 구성                                            │
│ - Classroom A: 8m x 6m                                 │
│ - Classroom B: 8m x 6m                                 │
│ - Hallway: 16m x 3m (복도)                             │
│                                                        │
│ ## 연결                                                 │
│ - Classroom A ↔ Hallway (문)                           │
│ - Classroom B ↔ Hallway (문)                           │
│                                                        │
│ ## 배치도 (ASCII)                                       │
│ ┌───────────┐   ┌───────────┐                          │
│ │Classroom A│   │Classroom B│                          │
│ │   8x6m    │   │   8x6m    │                          │
│ └─────◠─────┘   └─────◠─────┘                          │
│       └───────┬───────┘                                │
│         ┌─────┴─────┐                                  │
│         │  Hallway  │                                  │
│         │  16x3m    │                                  │
│         └───────────┘                                  │
└────────────────────────────────────────────────────────┘

유저: "교실 크기 10x8로 늘려주세요"

AI가 MD 수정 → 유저 확인 → 반복...

유저: "네, 이제 좋아요!" ← 승인
```

### 2단계: Image 생성 (시각적 확인)

```
MD 승인 후:
├── AI가 이미지 생성 AI API 호출
├── 정밀 평면도 이미지 생성
└── 유저에게 보여줌

유저: "문 위치가 좀 이상해요" → MD + Image 수정 → 반복
유저: "좋아요!" ← 승인
```

### 3단계: JSON 생성 (빌드 데이터)

```
MD + Image 승인 후:
├── AI가 정밀 수치화
├── JSON 스키마에 맞게 변환
├── 검증 규칙 통과 확인
└── 빌드 준비 완료
```

### 양방향 변환

MD는 다른 산출물과 양방향 변환 가능:

```
유저 이미지 제공 시:
Image → AI 해석 → MD 작성 → 유저 확인/수정

JSON 수정 필요 시:
JSON → MD 재생성 → 유저 확인 → Image 재생성
```

---

## MD 구조

### 필수 섹션

```markdown
# [맵 이름]

> [한 줄 설명]

## 1. 설계 기준
[스케일, 벽 두께, 천장 높이 등]

## 2. 공간 목록
[방 이름, 크기, 용도]

## 3. 연결 관계
[어떤 방이 어떻게 연결되는지]

## 4. 층 구조 (다층 시)
[층별 구성]
```

### 선택 섹션

```markdown
## 5. 개구부 상세
[문/창문 크기, 위치]

## 6. 특수 구조물
[계단, 기둥 등]

## 7. 배치물
[프롭 위치]
```

---

## 표현 규칙

### 공간 표현

| JSON | MD 표현 |
|------|---------|
| `room_id: "room_classroom_a"` | `Classroom A (room_classroom_a)` |
| `size: [8, 3, 6]` | `8m x 6m (높이 3m)` 또는 `8x6x3m` |
| `position: [4, 0, 3]` | `위치: (4, 0, 3)` 또는 생략 |
| `shape: "polygon"` | `L자형` 또는 `다각형 (5개 꼭지점)` |

**예시:**
```markdown
### Classroom A (room_classroom_a)
- 크기: 8m x 6m (높이 3m)
- 형태: 직사각형
- 층: 1층
```

### 연결 표현

| JSON | MD 표현 |
|------|---------|
| `type: "door"` | `→ (문) →` 또는 `[문]` |
| `type: "archway"` | `→ (아치) →` 또는 `[열린 통로]` |
| `type: "stairs"` | `→ (계단) →` 또는 `[계단]` |
| `wall_owner: "room_a"` | `벽 소유: Classroom A` |

**예시:**
```markdown
### 연결 관계

| 방 A | 연결 | 방 B | 비고 |
|------|------|------|------|
| Classroom A | 문 | Hallway | 남쪽 벽 |
| Classroom B | 문 | Hallway | 남쪽 벽 |
| 1F Hallway | 계단 | 2F Hallway | |
```

또는 다이어그램:
```
Classroom A ──[문]── Hallway ──[문]── Classroom B
```

### 치수 표현

| 표현 방식 | 예시 |
|----------|------|
| 가로 x 세로 | `8m x 6m` |
| 가로 x 세로 x 높이 | `8x6x3m` |
| 괄호 표기 | `(8, 6)m` |

**일관성 유지**: 문서 내에서 한 가지 방식만 사용

### 위치 표현

위치는 **유저에게 불필요한 경우 생략** 가능:

```markdown
# 생략 (권장)
- Classroom A: 8m x 6m

# 포함 (필요 시)
- Classroom A: 8m x 6m, 위치 (4, 0, 3)
```

---

## ASCII 다이어그램 (핵심)

**MD의 핵심 요소**: ASCII 다이어그램으로 공간 배치를 시각화

### 평면도 (필수)

```
                    N
                    ↑
┌─────────────────────────────────────┐
│                                     │
│   ┌───────────┐   ┌───────────┐    │
│   │           │   │           │    │
│   │Classroom A│   │Classroom B│    │
│   │  8x6m     │   │  8x6m     │    │
│   │           │   │           │    │
│   └─────◠─────┘   └─────◠─────┘    │
│         │               │          │
│   ┌─────┴───────────────┴─────┐    │
│   │                           │    │
│   │        Hallway            │    │
│   │        16x3m              │    │
│   │                           │    │
│   └───────────────────────────┘    │
│                                     │
│   Scale: ████ = 5m                  │
└─────────────────────────────────────┘
```

### 평면도 필수 요소

| 요소 | 표현 방식 |
|------|----------|
| 방 외곽 | 박스 문자 (┌┐└┘─│) |
| 방 이름 | 내부 텍스트 |
| 방 크기 | `8x6m` 형식 |
| 문 | ◠ (호) 또는 │ (열린 구간) |
| 창문 | ═══ (이중선) |
| 축 방향 | N↑ 또는 +Z↑ |
| 스케일 | `████ = 5m` |

### 연결 다이어그램

```
간단한 형태:
Classroom A ──[D]── Hallway ──[D]── Classroom B

[D] = Door, [A] = Archway, [S] = Stairs
```

### 복잡한 구조

```
┌─────────────┐         ┌─────────────┐
│ Classroom A │───[D]───│ Classroom B │
└──────┬──────┘         └──────┬──────┘
       │                       │
      [D]                     [D]
       │                       │
       └───────────┬───────────┘
                   │
            ┌──────┴──────┐
            │   Hallway   │
            └─────────────┘
```

### 다층 구조 (정면도)

```
    ┌─────────────────────────────────┐ ← 6m
    │              2F                 │
    │         (ceiling: 3m)           │
    │                     ╱───────────┤ ← 계단
    ├─ ─ ─ ─ ─ ─ ─ ─ ─ ─╱─ ─ ─ ─ ─ ─┤ ← 3m
    │              1F   ╱             │
    │         (ceiling: 3m)           │
    │                                 │
    └─────────────────────────────────┘ ← 0m (지면)
```

---

## 일치성 검증

### MD ↔ JSON 체크리스트

| 검증 항목 | 방법 |
|----------|------|
| 방 개수 | MD의 공간 목록 == JSON의 rooms.length |
| 방 이름 | MD의 각 방 이름 == JSON의 room.name |
| 방 크기 | MD의 치수 == JSON의 room.size |
| 연결 개수 | MD의 연결 == JSON의 connections.length |
| 연결 타입 | MD의 문/아치/계단 == JSON의 connection.type |

### MD ↔ Image 체크리스트

| 검증 항목 | 방법 |
|----------|------|
| 공간 배치 | MD의 설명 == Image의 시각적 배치 |
| 연결 관계 | MD의 다이어그램 == Image의 개구부 |
| 층 구조 | MD의 층 설명 == Image의 정면도 |

---

## 예시: 완성된 MD

```markdown
# School_Level_01

> 학교 1층 - 교실 2개와 복도

## 설계 기준

| 항목 | 값 |
|------|-----|
| 1 유닛 | 1m |
| 벽 두께 | 0.2m |
| 천장 높이 | 3m |
| 문 크기 | 1.5m x 2.2m |

## 공간 목록

| 이름 | ID | 크기 | 용도 |
|------|-----|------|------|
| Classroom A | room_classroom_a | 8x6m | 교실 |
| Classroom B | room_classroom_b | 8x6m | 교실 |
| Hallway | room_hallway | 16x3m | 복도 |

## 연결 관계

```
Classroom A ──[문]── Hallway ──[문]── Classroom B
```

| 연결 | 방 A | 방 B | 타입 | 벽 소유 |
|------|------|------|------|---------|
| 1 | Classroom A | Hallway | 문 | Classroom A |
| 2 | Classroom B | Hallway | 문 | Classroom B |

## Unity 계층 구조

```
Map_School
└── Floor_1F
    ├── Classroom_A
    │   ├── Floor
    │   ├── Ceiling
    │   ├── Wall_North
    │   ├── Wall_East
    │   ├── Wall_South (문 포함)
    │   └── Wall_West
    ├── Classroom_B
    └── Hallway
```
```

---

## 참고 문서

- [00-overview.md](00-overview.md) - 전체 개요
- [01-outputs.md](01-outputs.md) - 산출물 정의
- [02-json-schema.md](02-json-schema.md) - JSON 스키마
- [03-validation-rules.md](03-validation-rules.md) - 검증 규칙
- [05-image-spec.md](05-image-spec.md) - Image 명세
